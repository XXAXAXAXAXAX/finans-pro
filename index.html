<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finans V22 (Patron Modu)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        /* TEMA DEÄžÄ°ÅžKENLERÄ° */
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --primary: #4f46e5;
            --secondary: #8b5cf6;
            --input-bg: #f8fafc;
        }

        /* KARANLIK MOD (SADE & NET) */
        [data-theme="dark"] {
            --bg-color: #121212;         /* Tam Siyah Zemin */
            --card-bg: #1e1e1e;          /* Koyu Gri Kartlar */
            --text-color: #ffffff;       /* Beyaz YazÄ± */
            --text-muted: #a0a0a0;       /* Gri YazÄ± */
            --border-color: #333333;
            --input-bg: #2d2d2d;
        }

        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 90px; transition: 0.3s; }

        /* HEADER */
        .header-bg { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            padding: 20px 20px 30px 20px; 
            border-radius: 0 0 35px 35px; 
            color: white; 
            box-shadow: 0 15px 40px -10px rgba(79, 70, 229, 0.4); 
        }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .icon-btn { font-size: 1.5rem; color: white; cursor: pointer; opacity: 0.9; transition: 0.2s; background: none; border: none; }
        .icon-btn:hover { transform: scale(1.1); opacity: 1; }
        .excel-btn { background: rgba(255,255,255,0.2); border: none; color: white; font-weight: 700; border-radius: 20px; padding: 5px 15px; font-size: 0.85rem; backdrop-filter: blur(5px); }

        /* MERKEZÄ° BÄ°LGÄ°LER */
        .total-balance { font-size: 3rem; font-weight: 800; letter-spacing: -1.5px; line-height: 1.1; }
        .kdv-badge { background: rgba(255,255,255,0.15); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: #e0e7ff; margin-top: 10px; display: inline-block; border: 1px solid rgba(255,255,255,0.1); }
        .stat-box { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 10px 20px; min-width: 100px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }

        /* BÃœTÃ‡E BAR */
        .budget-wrapper { background: rgba(255,255,255,0.1); border-radius: 10px; height: 10px; width: 100%; margin-top: 15px; overflow: hidden; position: relative; }
        .budget-fill { height: 100%; background: #10b981; width: 0%; transition: 1s; }
        .budget-label { font-size: 0.75rem; color: #e0e7ff; margin-top: 5px; font-weight: 600; display: flex; justify-content: space-between; }

        /* KARTLAR & LÄ°STE */
        .accounts-wrapper { margin-top: -30px; padding-left: 20px; overflow-x: auto; white-space: nowrap; scrollbar-width: none; padding-bottom: 10px; }
        .acc-card { position: relative; display: inline-block; background: var(--card-bg); width: 160px; padding: 15px; border-radius: 20px; margin-right: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border-color); vertical-align: top; }
        .acc-del-btn { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: #fee2e2; color: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }

        .bg-white-custom { background-color: var(--card-bg) !important; color: var(--text-color); }
        .tx-list-item { background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid var(--border-color); }
        .icon-box { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 15px; flex-shrink: 0; }
        
        /* INPUT & MODAL */
        .modal-content { background-color: var(--card-bg); color: var(--text-color); border-radius: 24px; border: 1px solid var(--border-color); }
        .form-control, .form-select { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; }
        .form-control:focus { background-color: var(--input-bg); color: var(--text-color); }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); height: 75px; display: flex; justify-content: space-around; align-items: center; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 900; border-top: 1px solid var(--border-color); }
        .nav-btn { font-size: 1.5rem; color: var(--text-muted); background: none; border: none; padding: 10px; }
        .nav-btn.active { color: var(--primary); }
        .fab-main { width: 65px; height: 65px; background: var(--text-color); color: var(--card-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; position: relative; top: -30px; border: 6px solid var(--bg-color); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        
        #voiceBtn { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, #f43f5e, #be123c); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 5px 20px rgba(244, 63, 94, 0.5); z-index: 100; }
        #voiceOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; }
        .page { display: none; padding-top: 20px; } .page.active { display: block; }
        #loader { position: fixed; inset: 0; background: var(--bg-color); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-primary mb-3"></div><h6 class="fw-bold">YÃ¼kleniyor...</h6></div>

<div id="mainHeader" class="header-bg">
    <div class="header-controls">
        <div class="d-flex gap-3">
            <button class="icon-btn" onclick="settingsModal.show()"><i class="bi bi-gear-fill"></i></button>
            <button class="icon-btn" onclick="toggleTheme()"><i id="themeIcon" class="bi bi-moon-stars-fill"></i></button>
        </div>
        <button onclick="excelExport()" class="excel-btn"><i class="bi bi-file-earmark-spreadsheet me-1"></i>Excel</button>
    </div>

    <div class="text-center">
        <div class="small opacity-75 fw-bold letter-spacing-2">CÃœZDANIM</div>
        <div class="small fw-bold opacity-75 mb-1">NET VARLIK</div>
        <div class="total-balance" id="dispNet">0.00 â‚º</div>
        
        <div class="px-4">
            <div class="budget-wrapper"><div class="budget-fill" id="budgetBar"></div></div>
            <div class="budget-label">
                <span>Harcama: <span id="spentVal">0</span>â‚º</span>
                <span>Limit: <span id="limitVal">0</span>â‚º</span>
            </div>
        </div>

        <div class="mt-4 d-flex justify-content-center gap-3">
            <div class="stat-box text-start">
                <div class="small opacity-75 fw-bold mb-1">GELÄ°R</div>
                <div class="fw-bold fs-5 d-flex align-items-center gap-2"><i class="bi bi-arrow-down-circle-fill text-white"></i> <span id="dispInc">0</span></div>
            </div>
            <div class="stat-box text-start">
                <div class="small opacity-75 fw-bold mb-1">GÄ°DER</div>
                <div class="fw-bold fs-5 d-flex align-items-center gap-2"><i class="bi bi-arrow-up-circle-fill text-danger-emphasis"></i> <span id="dispExp">0</span></div>
            </div>
        </div>
    </div>
</div>

<div id="voiceOverlay">
    <i class="bi bi-mic-fill fs-1 mb-3 text-danger"></i><h4 class="fw-bold">Dinliyorum...</h4>
    <button class="btn btn-outline-light rounded-pill mt-4 px-4" onclick="stopVoice()">Ä°ptal</button>
</div>

<div id="homePage" class="page active">
    <div class="accounts-wrapper" id="accWrapper"></div>
    <div class="container mt-4">
        <div class="bg-white-custom p-3 rounded-4 shadow-sm mb-4 border d-flex gap-3 align-items-start">
            <i class="bi bi-stars fs-3 text-warning"></i>
            <div><div class="fw-bold">FinansBot</div><div id="aiMsg" class="small text-muted">Analiz...</div></div>
        </div>
        
        <div class="bg-white-custom p-3 rounded-4 shadow-sm mb-4 border">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold text-muted small m-0">RAPOR</h6>
                <select class="form-select form-select-sm w-auto fw-bold" onchange="drawChart(this.value)"><option value="pie">Pasta</option><option value="bar">Trend</option></select>
            </div>
            <div style="height:200px"><canvas id="mainChart"></canvas></div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3"><h6 class="fw-bold text-muted small m-0">SON Ä°ÅžLEMLER</h6><small class="text-primary fw-bold" onclick="goPage('txPage')">TÃ¼mÃ¼</small></div>
        <div id="recentList" class="pb-5"></div>
    </div>
</div>

<div id="txPage" class="page container" style="display:none; padding-top:20px;">
    <h4 class="fw-bold mb-4">GeÃ§miÅŸ</h4>
    <div class="d-flex gap-2 mb-3">
        <select id="fMonth" class="form-select fw-bold shadow-sm" onchange="renderTx()"></select>
        <select id="fType" class="form-select fw-bold shadow-sm" onchange="renderTx()"><option value="all">TÃ¼mÃ¼</option><option value="gelir">Gelir</option><option value="gider">Gider</option></select>
    </div>
    <div id="fullTxList" class="pb-5"></div>
</div>

<div id="debtPage" class="page container" style="display:none; padding-top:20px;">
    <div class="d-flex justify-content-between mb-4"><h4 class="fw-bold m-0">BorÃ§lar</h4><button class="btn btn-primary rounded-pill px-3 fw-bold" onclick="debtModal.show()">+ Ekle</button></div>
    <div id="debtList" class="pb-5"></div>
</div>

<div class="bottom-nav">
    <button class="nav-btn active" onclick="goPage('homePage', this)"><i class="bi bi-grid-fill"></i></button>
    <button class="nav-btn" onclick="goPage('txPage', this)"><i class="bi bi-wallet2"></i></button>
    <div class="fab-main" onclick="menuModal.show()"><i class="bi bi-plus-lg"></i></div>
    <button class="nav-btn" onclick="goPage('debtPage', this)"><i class="bi bi-arrow-left-right"></i></button>
</div>
<div id="voiceBtn" onclick="startVoice()"><i class="bi bi-mic-fill"></i></div>

<div class="modal fade" id="settingsModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0"><h5 class="fw-bold">Ayarlar</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <h6 class="fw-bold mb-2 text-primary">ðŸ’° AylÄ±k BÃ¼tÃ§e Limiti</h6>
                <div class="input-group mb-4">
                    <input type="number" id="budgetLimitInp" class="form-control fw-bold" placeholder="Ã–rn: 20000">
                    <button class="btn btn-success" onclick="saveBudget()">Kaydet</button>
                </div>
                <hr>
                <h6 class="fw-bold mb-2 text-muted">Yedekleme</h6>
                <button class="btn btn-outline-primary w-100 fw-bold mb-2" onclick="downloadBackup()"><i class="bi bi-cloud-arrow-down-fill me-2"></i> YedeÄŸi Ä°ndir</button>
                <label class="btn btn-outline-dark w-100 fw-bold" style="cursor:pointer"><i class="bi bi-cloud-arrow-up-fill me-2"></i> Yedek YÃ¼kle<input type="file" id="backupFile" accept=".json" hidden onchange="restoreBackup(this)"></label>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="menuModal"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content p-3"><h6 class="text-center text-muted fw-bold mb-3">EKLE</h6><div class="d-grid gap-2"><button class="btn btn-success p-3 fw-bold text-start" onclick="openTx('gelir')">Gelir</button><button class="btn btn-danger p-3 fw-bold text-start" onclick="openTx('gider')">Gider</button><button class="btn btn-dark p-3 fw-bold text-start" onclick="openCam()">FiÅŸ Tara</button></div></div></div></div>
<div class="modal fade" id="txModal" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0 pb-0"><h5 class="fw-bold" id="txTitle"></h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="txType"><div id="previewBox" class="text-center d-none mb-3"><img id="prevImg" class="rounded shadow-sm" style="height:100px"></div><div class="row g-2 mb-3"><div class="col-8"><label class="small fw-bold text-muted">Tutar</label><input type="number" step="0.01" id="txAmt" class="form-control fs-4 fw-bold text-primary" placeholder="0" oninput="calcKDV()"></div><div class="col-4"><label class="small fw-bold text-muted">KDV</label><select id="taxRate" class="form-select fs-6 fw-bold bg-light" onchange="calcKDV()"><option value="20">%20</option><option value="10">%10</option><option value="1">%1</option><option value="0">%0</option></select></div></div><div class="d-flex justify-content-between mb-3 px-2"><small class="text-muted">Net: <span id="lblNet" class="fw-bold">0</span>â‚º</small><small class="text-danger">KDV: <span id="lblTax" class="fw-bold">0</span>â‚º</small></div><div class="row g-2 mb-3"><div class="col-6"><label class="small fw-bold text-muted">Tarih</label><input type="date" id="txDate" class="form-control fw-bold"></div><div class="col-6"><label class="small fw-bold text-muted">Hesap</label><select id="txAcc" class="form-select fw-bold"></select></div></div><div class="mb-3"><label class="small fw-bold text-muted">Kategori</label><select id="txCat" class="form-select fw-bold"></select></div><input type="text" id="txDesc" class="form-control" placeholder="AÃ§Ä±klama"></div><div class="modal-footer border-0 pt-0"><button onclick="saveTx()" class="btn btn-primary w-100 py-3 fw-bold rounded-4">KAYDET</button></div></div></div></div>
<div class="modal fade" id="imgModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-2 bg-transparent border-0 text-center"><img id="viewImg" style="max-height:80vh; max-width:100%; border-radius:10px;"><button class="btn btn-light rounded-pill mt-3 mx-auto px-4" data-bs-dismiss="modal">Kapat</button></div></div></div>
<div class="modal fade" id="accModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="fw-bold">Yeni Hesap</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="newAccName" class="form-control mb-3 fw-bold" placeholder="AdÄ±"><select id="newAccType" class="form-select mb-3"><option value="bank">Banka</option><option value="card">Kart</option><option value="cash">Nakit</option></select><input type="number" id="newAccBal" class="form-control fw-bold" placeholder="Bakiye"></div><div class="modal-footer border-0"><button onclick="addAccount()" class="btn btn-primary w-100 fw-bold">OLUÅžTUR</button></div></div></div></div>
<div class="modal fade" id="debtModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="fw-bold">BorÃ§</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><select id="debtType" class="form-select mb-3 fw-bold"><option value="alacak">AlacaÄŸÄ±m (+)</option><option value="borc">Borcum (-)</option></select><input type="text" id="debtWho" class="form-control mb-2" placeholder="KiÅŸi"><input type="number" id="debtAmt" class="form-control fw-bold mb-2" placeholder="Tutar"><input type="date" id="debtDate" class="form-control"></div><div class="modal-footer border-0"><button onclick="saveDebt()" class="btn btn-primary w-100 fw-bold">KAYDET</button></div></div></div></div>
<input type="file" id="fileInp" accept="image/*" hidden>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const DB_KEY = 'finans_v22_db';
    // DB'ye budget (BÃ¼tÃ§e) ve theme (Tema) eklendi
    let db = JSON.parse(localStorage.getItem(DB_KEY)) || { txs: [], accs: [{id:1,name:'Nakit',type:'cash',bal:0}], debts: [], budget: 0, theme: 'light' };
    let menuModal, txModal, accModal, debtModal, imgModal, settingsModal, mainChart;
    let currentImgData = null;
    const CATS = { gelir:['MaaÅŸ','Ek Ä°ÅŸ','SatÄ±ÅŸ','YatÄ±rÄ±m'], gider:['Market','Yemek','UlaÅŸÄ±m','Fatura','Kira','EÄŸlence','Giyim','DiÄŸer'] };

    window.onload = function() {
        menuModal = new bootstrap.Modal(document.getElementById('menuModal'));
        txModal = new bootstrap.Modal(document.getElementById('txModal'));
        accModal = new bootstrap.Modal(document.getElementById('accModal'));
        debtModal = new bootstrap.Modal(document.getElementById('debtModal'));
        imgModal = new bootstrap.Modal(document.getElementById('imgModal'));
        settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
        
        loadScript('https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js');
        
        // Tema ve BÃ¼tÃ§e YÃ¼kle
        applyTheme(db.theme);
        document.getElementById('budgetLimitInp').value = db.budget || '';

        initFilters(); refreshAll();
    };

    // --- TEMA YÃ–NETÄ°MÄ° ---
    function toggleTheme() {
        db.theme = db.theme === 'light' ? 'dark' : 'light';
        applyTheme(db.theme);
        saveDB();
    }
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        const icon = document.getElementById('themeIcon');
        if(theme === 'dark') { icon.className = 'bi bi-sun-fill'; } 
        else { icon.className = 'bi bi-moon-stars-fill'; }
    }

    // --- BÃœTÃ‡E YÃ–NETÄ°MÄ° ---
    function saveBudget() {
        const val = parseFloat(document.getElementById('budgetLimitInp').value);
        if(val >= 0) {
            db.budget = val;
            saveDB();
            refreshAll();
            settingsModal.hide();
            alert("BÃ¼tÃ§e limiti ayarlandÄ±! ðŸŽ¯");
        }
    }

    function goPage(pid, btn) {
        document.querySelectorAll('.page').forEach(p=>{p.style.display='none'; p.classList.remove('active')});
        document.getElementById(pid).style.display='block';
        if(btn){ document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        document.getElementById('mainHeader').style.display = (pid==='homePage')?'block':'none';
        if(pid==='homePage') refreshAll(); if(pid==='txPage') renderTx(); if(pid==='debtPage') renderDebt();
    }

    // STANDART FONKSÄ°YONLAR (V21 ile aynÄ±, sadece gÃ¶rsel uyum saÄŸlandÄ±)
    function openTx(type, isScan=false) {
        menuModal.hide(); document.getElementById('txType').value = type;
        document.getElementById('txTitle').innerText = type==='gelir'?'GELÄ°R EKLE':'GÄ°DER EKLE';
        const c=document.getElementById('txCat'); c.innerHTML=''; CATS[type].forEach(x=>c.add(new Option(x,x)));
        const a=document.getElementById('txAcc'); a.innerHTML=''; db.accs.forEach(x=>a.add(new Option(x.name,x.id)));
        document.getElementById('previewBox').classList.toggle('d-none', !isScan);
        if(!isScan){ document.getElementById('txAmt').value=''; currentImgData=null; }
        document.getElementById('txDate').valueAsDate = new Date(); document.getElementById('taxRate').value = '20'; calcKDV(); txModal.show();
    }
    function calcKDV(){ const a=parseFloat(document.getElementById('txAmt').value)||0; const r=parseInt(document.getElementById('taxRate').value); const t=a-(a/(1+r/100)); document.getElementById('lblTax').innerText=t.toFixed(2); document.getElementById('lblNet').innerText=(a-t).toFixed(2); }
    function saveTx(){ const a=parseFloat(document.getElementById('txAmt').value); if(!a)return; const r=parseInt(document.getElementById('taxRate').value); const t=a-(a/(1+r/100)); const typ=document.getElementById('txType').value; const tx={id:Date.now(), type:typ, amt:a, tax:t, rate:r, accId:parseInt(document.getElementById('txAcc').value), date:document.getElementById('txDate').value, cat:document.getElementById('txCat').value, desc:document.getElementById('txDesc').value, img:currentImgData}; const acc=db.accs.find(x=>x.id===tx.accId); if(acc) acc.bal+=(typ==='gelir'?a:-a); db.txs.push(tx); saveDB(); txModal.hide(); refreshAll(); }
    
    function deleteTx(id){ if(!confirm('Sil?'))return; const tx=db.txs.find(t=>t.id===id); if(tx){const acc=db.accs.find(a=>a.id===tx.accId); if(acc) acc.bal+=(tx.type==='gelir'?-tx.amt:tx.amt); db.txs=db.txs.filter(t=>t.id!==id); saveDB(); refreshAll(); if(document.getElementById('txPage').style.display==='block') renderTx();} }
    function deleteAcc(id){ if(confirm("Hesap Silinsin mi?")){db.accs=db.accs.filter(a=>a.id!==id); saveDB(); refreshAll();} }
    function addAccount(){ const n=document.getElementById('newAccName').value; if(n){db.accs.push({id:Date.now(), name:n, type:document.getElementById('newAccType').value, bal:parseFloat(document.getElementById('newAccBal').value)||0}); saveDB(); accModal.hide(); refreshAll();} }
    function viewImage(d){ document.getElementById('viewImg').src=d; imgModal.show(); }

    function openCam(){ document.getElementById('fileInp').click(); }
    document.getElementById('fileInp').addEventListener('change', async function(){ if(!this.files.length)return; menuModal.hide(); document.getElementById('loader').style.display='flex'; try{ const blob=await resize(this.files[0]); const r=new FileReader(); r.readAsDataURL(blob); r.onloadend=async()=>{ currentImgData=r.result; document.getElementById('prevImg').src=currentImgData; if(typeof Tesseract==='undefined') await loadScript('https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js'); const w=await Tesseract.createWorker(); await w.loadLanguage('tur'); await w.initialize('tur'); const {data:{text}}=await w.recognize(blob); await w.terminate(); parseOCR(text); openTx('gider',true); document.getElementById('loader').style.display='none'; } } catch(e){ openTx('gider',true); document.getElementById('loader').style.display='none'; } this.value=''; });
    function parseOCR(t){ const p=t.match(/\d+[.,]\d{2}/g); if(p){ const tot=Math.max(...p.map(s=>parseFloat(s.replace(',','.')))); document.getElementById('txAmt').value=tot.toFixed(2); calcKDV(); } if(t.toLowerCase().includes('market')) document.getElementById('txCat').value='Market'; }
    function resize(f){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height;if(w>600){h*=600/w;w=600}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);c.toBlob(r,'image/jpeg',0.5)};i.src=e.target.result};rd.readAsDataURL(f)})}

    function startVoice() { if(!('webkitSpeechRecognition' in window)) return alert("Desteklenmiyor"); const rec=new webkitSpeechRecognition(); rec.lang='tr-TR'; document.getElementById('voiceOverlay').style.display='flex'; rec.start(); rec.onresult=e=>{ document.getElementById('voiceOverlay').style.display='none'; const t=e.results[0][0].transcript.toLowerCase(); const n=t.match(/\d+/); if(t.includes('borÃ§')||t.includes('alacak')){ debtModal.show(); document.getElementById('debtWho').value=t.replace(/borÃ§|alacak|\d+/g,'').trim(); if(n)document.getElementById('debtAmt').value=n[0]; document.getElementById('debtDate').valueAsDate=new Date(); if(t.includes('verdim'))document.getElementById('debtType').value='alacak'; } else if(t.includes('maaÅŸ')||t.includes('gelir')){ openTx('gelir'); if(n){document.getElementById('txAmt').value=n[0]; calcKDV();} document.getElementById('txDesc').value=t; } else { openTx('gider'); if(n){document.getElementById('txAmt').value=n[0]; calcKDV();} document.getElementById('txDesc').value=t; } }; rec.onerror=()=>stopVoice(); rec.onend=()=>stopVoice(); }
    function stopVoice(){ document.getElementById('voiceOverlay').style.display='none'; }
    
    function refreshAll() {
        let i=0,e=0,k=0; db.txs.forEach(t=>{if(t.type==='gelir')i+=t.amt; else {e+=t.amt; k+=(t.tax||0);}});
        document.getElementById('dispNet').innerText=(i-e).toFixed(2)+' â‚º'; document.getElementById('dispInc').innerText=i.toFixed(0); document.getElementById('dispExp').innerText=e.toFixed(0);
        
        // BÃœTÃ‡E HESABI
        document.getElementById('spentVal').innerText = e.toFixed(0);
        document.getElementById('limitVal').innerText = db.budget.toFixed(0);
        const bar = document.getElementById('budgetBar');
        if(db.budget > 0) {
            const pct = Math.min((e / db.budget) * 100, 100);
            bar.style.width = pct + '%';
            if(pct < 80) bar.style.background = '#10b981'; // YeÅŸil
            else if(pct < 100) bar.style.background = '#f59e0b'; // Turuncu
            else bar.style.background = '#ef4444'; // KÄ±rmÄ±zÄ±
        } else { bar.style.width = '0%'; }

        const aw=document.getElementById('accWrapper'); const addBtn=`<div class="add-acc-card" onclick="accModal.show()" style="display:inline-flex; align-items:center; justify-content:center; width:50px; height:100px; background:rgba(255,255,255,0.5); border-radius:20px; border:2px dashed #cbd5e1; cursor:pointer; vertical-align:top;"><i class="bi bi-plus-lg fs-3 text-muted"></i></div>`;
        aw.innerHTML=''; db.accs.forEach(a=>{ let ico='bi-wallet2'; if(a.type==='bank')ico='bi-bank'; if(a.type==='card')ico='bi-credit-card'; aw.innerHTML+=`<div class="acc-card"><div class="acc-del-btn" onclick="deleteAcc(${a.id})"><i class="bi bi-x"></i></div><div class="acc-icon"><i class="bi ${ico}"></i></div><div class="small fw-bold text-muted text-truncate">${a.name}</div><div class="fw-bold fs-5">${a.bal.toFixed(2)}â‚º</div></div>`; }); aw.innerHTML+=addBtn;
        const am=document.getElementById('aiMsg'); if(!db.txs.length) am.innerText="Veri bekleniyor..."; else if(i>e) am.innerText="Durum iyi!"; else am.innerText="Giderler yÃ¼ksek.";
        renderList('recentList', db.txs.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5)); drawChart('pie');
    }

    function downloadBackup() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); const a = document.createElement('a'); a.href = dataStr; a.download = "finans_yedek_" + new Date().toISOString().slice(0,10) + ".json"; document.body.appendChild(a); a.click(); a.remove(); }
    function restoreBackup(input) { const file = input.files[0]; if(!file) return; const r = new FileReader(); r.onload = function(e) { try { db = JSON.parse(e.target.result); saveDB(); settingsModal.hide(); refreshAll(); alert("YÃ¼klendi!"); } catch(err) { alert("Hata!"); } }; r.readAsText(file); input.value = ''; }

    function renderList(tid, list) {
        const el=document.getElementById(tid); el.innerHTML=''; if(!list.length) el.innerHTML='<div class="text-center small text-muted my-3">KayÄ±t yok</div>';
        list.forEach(t=>{ const isInc=t.type==='gelir'; const imgBtn=t.img?`<i class="bi bi-image text-primary fs-5 me-2" onclick="viewImage('${t.img}')" style="cursor:pointer"></i>`:''; el.innerHTML+=`<div class="tx-list-item"><div class="d-flex align-items-center"><div class="icon-box" style="background:${isInc?'#dcfce7':'#fee2e2'}; color:${isInc?'#166534':'#991b1b'}"><i class="bi ${isInc?'bi-arrow-down':'bi-bag'}"></i></div><div><div class="fw-bold">${t.cat}</div><small class="text-muted">${t.date} â€¢ %${t.rate||20} KDV</small></div></div><div class="text-end"><div class="fw-bold ${isInc?'text-success':'text-danger'}">${isInc?'+':'-'}${t.amt}â‚º</div><div>${imgBtn}<i class="bi bi-trash3 text-muted opacity-25 ms-2" onclick="deleteTx(${t.id})"></i></div></div></div>`; });
    }
    
    function renderTx() { const m=parseInt(document.getElementById('fMonth').value), typ=document.getElementById('fType').value; const l=db.txs.filter(t=>{const d=new Date(t.date); return d.getMonth()===m && (typ==='all'||t.type===typ)}).sort((a,b)=>new Date(b.date)-new Date(a.date)); renderList('fullTxList', l); }
    function renderDebt(){ const l=document.getElementById('debtList'); l.innerHTML=''; db.debts.forEach(d=>{ const c=d.type==='alacak'?'text-success':'text-danger'; l.innerHTML+=`<div class="tx-list-item" style="${d.paid?'opacity:0.5;text-decoration:line-through':''}"><div class="d-flex align-items-center"><div class="icon-box bg-light ${c}"><i class="bi bi-arrow-left-right"></i></div><div><div class="fw-bold">${d.who}</div><small class="text-muted">${d.date}</small></div></div><div class="text-end"><div class="fw-bold ${c}">${d.amt}â‚º</div><button class="btn btn-sm btn-outline-secondary py-0 mt-1" onclick="togglePaid(${d.id})">${d.paid?'Ã–dendi':'Ã–de'}</button><i class="bi bi-trash3 text-danger ms-2" onclick="delDebt(${d.id})"></i></div></div>`; }); }
    function saveDebt(){ db.debts.push({id:Date.now(), type:document.getElementById('debtType').value, who:document.getElementById('debtWho').value, amt:parseFloat(document.getElementById('debtAmt').value)||0, date:document.getElementById('debtDate').value, paid:false}); saveDB(); debtModal.hide(); renderDebt(); }
    function togglePaid(id){ const d=db.debts.find(x=>x.id===id); if(d){d.paid=!d.paid; saveDB(); renderDebt();} }
    function delDebt(id){ if(confirm('Sil?')){db.debts=db.debts.filter(d=>d.id!==id); saveDB(); renderDebt();} }
    function drawChart(t){ const ctx=document.getElementById('mainChart'); if(!ctx)return; if(mainChart)mainChart.destroy(); let c={}; if(t==='pie'){ const d={}; db.txs.filter(x=>x.type==='gider').forEach(x=>d[x.cat]=(d[x.cat]||0)+x.amt); c={type:'doughnut',data:{labels:Object.keys(d),datasets:[{data:Object.values(d),backgroundColor:['#4f46e5','#ec4899','#10b981','#f59e0b']}]},options:{maintainAspectRatio:false,plugins:{legend:{position:'right'}}}}; } else { const l=[],d=[]; for(let i=6;i>=0;i--){const x=new Date();x.setDate(x.getDate()-i);l.push(x.toLocaleDateString('tr-TR',{weekday:'short'}));d.push(db.txs.filter(t=>t.date===x.toISOString().split('T')[0]&&t.type==='gider').reduce((a,b)=>a+b.amt,0));} c={type:'bar',data:{labels:l,datasets:[{label:'Harcama',data:d,backgroundColor:'#4f46e5',borderRadius:4}]},options:{maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{display:false},x:{grid:{display:false}}}}}; } mainChart=new Chart(ctx,c); }
    function saveDB(){localStorage.setItem(DB_KEY,JSON.stringify(db))}
    function loadScript(src){return new Promise(r=>{const s=document.createElement('script');s.src=src;s.onload=r;document.head.appendChild(s)})}
    function excelExport(){const ws=XLSX.utils.json_to_sheet(db.txs);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Data");XLSX.writeFile(wb,"FinansV22.xlsx")}
    function initFilters(){const m=["Ocak","Åžubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];const s=document.getElementById('fMonth');m.forEach((x,i)=>{const o=new Option(x,i);if(i===new Date().getMonth())o.selected=true;s.add(o)})}
</script>
</body>

</html> 
