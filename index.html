<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finans V26 (All-in-One)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root { --bg-color: #f8fafc; --card-bg: #ffffff; --text-color: #0f172a; --text-muted: #64748b; --border-color: #e2e8f0; --primary: #4f46e5; --secondary: #8b5cf6; --input-bg: #f8fafc; }
        [data-theme="dark"] { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #ffffff; --text-muted: #a0a0a0; --border-color: #333333; --input-bg: #2d2d2d; }

        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 90px; transition: 0.3s; }

        .header-bg { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 20px 20px 30px 20px; border-radius: 0 0 35px 35px; color: white; box-shadow: 0 15px 40px -10px rgba(79, 70, 229, 0.4); }
        .total-balance { font-size: 2.8rem; font-weight: 800; letter-spacing: -1.5px; }
        
        /* BORÇ KARTLARI */
        .debt-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .debt-val { font-weight: 800; }
        .debt-give { color: #ef4444; } /* Alacak */
        .debt-take { color: #10b981; } /* Borç */

        /* FOTOĞRAF ÖNİZLEME */
        .receipt-preview { width: 100%; max-height: 200px; object-fit: contain; border-radius: 12px; margin-top: 10px; border: 1px solid var(--border-color); display: none; }
        .tx-img-thumb { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; cursor: pointer; }

        /* NAV & GENEL */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); height: 75px; display: flex; justify-content: space-around; align-items: center; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 900; border-top: 1px solid var(--border-color); }
        .nav-btn { font-size: 1.4rem; color: var(--text-muted); background: none; border: none; padding: 10px; }
        .nav-btn.active { color: var(--primary); }
        .fab-main { width: 60px; height: 60px; background: var(--text-color); color: var(--card-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; position: relative; top: -25px; border: 5px solid var(--bg-color); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        
        .page { display: none; padding-top: 20px; } .page.active { display: block; }
        .tx-list-item { background: var(--card-bg); border-radius: 16px; padding: 12px 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border-color); }
        
        .stat-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .progress { height: 8px; border-radius: 4px; background: var(--bg-color); }
    </style>
</head>
<body>

<div id="mainHeader" class="header-bg">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn text-white p-0 fs-4" onclick="settingsModal.show()"><i class="bi bi-list"></i></button>
        <div class="fw-bold small opacity-75">V26 ALL-IN-ONE</div>
        <button class="btn text-white p-0 fs-4" onclick="toggleTheme()"><i id="themeIcon" class="bi bi-moon-stars-fill"></i></button>
    </div>
    <div class="text-center">
        <div class="small fw-bold opacity-75">TOPLAM BAKİYE</div>
        <div class="total-balance" id="dispNet">0.00 ₺</div>
        <div class="d-flex justify-content-center gap-3 mt-3">
            <div class="small fw-bold px-3 py-1 rounded-pill" style="background: rgba(255,255,255,0.15)">Gelir: <span id="dispInc">0</span></div>
            <div class="small fw-bold px-3 py-1 rounded-pill" style="background: rgba(255,255,255,0.15)">Gider: <span id="dispExp">0</span></div>
        </div>
    </div>
</div>

<div id="homePage" class="page active container">
    <h6 class="fw-bold text-muted small mb-3">SON İŞLEMLER</h6>
    <div id="recentList" class="pb-5"></div>
</div>

<div id="analysisPage" class="page container">
    <h4 class="fw-bold mb-4">Finansal Özet</h4>
    <div class="stat-card">
        <h6 class="fw-bold text-muted mb-3">BU YILIN ÖZETİ (2026)</h6>
        <div id="yearlyStats"></div>
    </div>
    <h6 class="fw-bold text-muted mb-3">KATEGORİ DAĞILIMI</h6>
    <div id="catAnalysisList" class="pb-5"></div>
</div>

<div id="debtPage" class="page container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold m-0">Borç / Alacak</h4>
        <button class="btn btn-primary rounded-pill px-3 fw-bold" onclick="debtModal.show()">+ Ekle</button>
    </div>
    <div id="debtList" class="pb-5"></div>
</div>

<div id="morePage" class="page container">
    <h4 class="fw-bold mb-4">Araçlar</h4>
    <div class="d-grid gap-3">
        <button class="btn btn-light p-3 text-start fw-bold border" onclick="createPDF()"><i class="bi bi-file-pdf text-danger me-2"></i> PDF Raporu Oluştur</button>
        <button class="btn btn-light p-3 text-start fw-bold border" onclick="excelExport()"><i class="bi bi-file-earmark-excel text-success me-2"></i> Excel Olarak İndir</button>
        <button class="btn btn-light p-3 text-start fw-bold border" onclick="openSubsModal()"><i class="bi bi-arrow-repeat text-primary me-2"></i> Abonelik Yönetimi</button>
        <button class="btn btn-outline-danger p-3 fw-bold" onclick="resetData()">Verileri Sıfırla</button>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-btn active" onclick="goPage('homePage', this)"><i class="bi bi-house-door-fill"></i></button>
    <button class="nav-btn" onclick="goPage('analysisPage', this)"><i class="bi bi-pie-chart-fill"></i></button>
    <div class="fab-main" onclick="menuModal.show()"><i class="bi bi-plus-lg"></i></div>
    <button class="nav-btn" onclick="goPage('debtPage', this)"><i class="bi bi-people-fill"></i></button>
    <button class="nav-btn" onclick="goPage('morePage', this)"><i class="bi bi-three-dots"></i></button>
</div>

<div class="modal fade" id="menuModal"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content p-3 border-0 shadow-lg" style="border-radius: 25px;"><h6 class="text-center text-muted fw-bold mb-3">İŞLEM TÜRÜ</h6><div class="d-grid gap-2"><button class="btn btn-success p-3 fw-bold" onclick="openTx('gelir')">GELİR EKLE</button><button class="btn btn-danger p-3 fw-bold" onclick="openTx('gider')">GİDER EKLE</button></div></div></div></div>

<div class="modal fade" id="txModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0" style="border-radius: 25px;"><div class="modal-header border-0 pb-0"><h5 class="fw-bold" id="txTitle">İşlem</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <input type="hidden" id="txType">
    <div class="mb-3"><label class="small fw-bold text-muted">Tutar</label><input type="number" id="txAmt" class="form-control fs-2 fw-bold text-primary border-0 bg-light p-3" style="border-radius: 15px;" placeholder="0.00"></div>
    <div class="row g-2 mb-3">
        <div class="col-6"><label class="small fw-bold text-muted">Kategori</label><select id="txCat" class="form-select fw-bold"></select></div>
        <div class="col-6"><label class="small fw-bold text-muted">Tarih</label><input type="date" id="txDate" class="form-control fw-bold"></div>
    </div>
    <div class="mb-3"><label class="small fw-bold text-muted">Açıklama</label><input type="text" id="txDesc" class="form-control" placeholder="Notunuz..."></div>
    
    <div class="mb-3">
        <label class="btn btn-outline-primary w-100 fw-bold py-2" style="border-radius: 12px; border-style: dashed;">
            <i class="bi bi-camera-fill me-2"></i> Fiş/Fotoğraf Ekle
            <input type="file" id="txFile" accept="image/*" hidden onchange="previewImage(this)">
        </label>
        <img id="previewImg" class="receipt-preview">
    </div>

</div><div class="modal-footer border-0 pt-0"><button onclick="saveTx()" class="btn btn-primary w-100 py-3 fw-bold rounded-4 shadow">İŞLEMİ KAYDET</button></div></div></div></div>

<div class="modal fade" id="debtModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border-radius: 25px;"><div class="modal-header border-0"><h5 class="fw-bold">Borç / Alacak Kaydı</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <div class="mb-3"><label class="small fw-bold text-muted">Kişi Adı</label><input type="text" id="debtPerson" class="form-control fw-bold" placeholder="Örn: Ahmet Yılmaz"></div>
    <div class="mb-3"><label class="small fw-bold text-muted">Tutar</label><input type="number" id="debtAmt" class="form-control fw-bold fs-4" placeholder="0.00"></div>
    <div class="mb-3"><label class="small fw-bold text-muted">Durum</label><select id="debtType" class="form-select fw-bold"><option value="take">Ondan Alacağım Var (Alacak)</option><option value="give">Ona Borcum Var (Borç)</option></select></div>
</div><div class="modal-footer border-0"><button onclick="saveDebt()" class="btn btn-primary w-100 fw-bold py-3 rounded-4">KAYDET</button></div></div></div></div>

<div class="modal fade" id="imageModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content bg-transparent border-0 text-center"><img id="fullImg" style="width:100%; border-radius:15px; box-shadow: 0 0 30px rgba(0,0,0,0.5);"><button class="btn btn-light mt-3 fw-bold rounded-pill mx-auto" data-bs-dismiss="modal">Kapat</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
    const DB_KEY = 'finans_v26_allinone';
    let db = JSON.parse(localStorage.getItem(DB_KEY)) || { 
        txs: [], debts: [], accs: [{id:1,name:'Nakit',bal:0}], 
        cats: { gelir:['Maaş','Ek İş','Satış'], gider:['Market','Yemek','Ulaşım','Fatura','Eğlence','Hediye','Diğer'] },
        theme: 'light' 
    };

    let menuModal, txModal, debtModal, imageModal;
    let selectedImageData = null;

    window.onload = function() {
        menuModal = new bootstrap.Modal(document.getElementById('menuModal'));
        txModal = new bootstrap.Modal(document.getElementById('txModal'));
        debtModal = new bootstrap.Modal(document.getElementById('debtModal'));
        imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
        
        applyTheme(db.theme);
        refreshAll();
    };

    function goPage(pid, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(btn) { document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        document.getElementById('mainHeader').style.display = (pid === 'homePage') ? 'block' : 'none';
        
        if(pid === 'homePage') refreshAll();
        if(pid === 'analysisPage') renderAnalysis();
        if(pid === 'debtPage') renderDebts();
    }

    // --- FOTOĞRAF İŞLEMLERİ ---
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImageData = e.target.result;
                const preview = document.getElementById('previewImg');
                preview.src = selectedImageData;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function showFullImage(data) {
        document.getElementById('fullImg').src = data;
        imageModal.show();
    }

    // --- İŞLEM KAYIT ---
    function openTx(type) {
        menuModal.hide();
        document.getElementById('txType').value = type;
        document.getElementById('txTitle').innerText = type === 'gelir' ? 'GELİR EKLE' : 'GİDER EKLE';
        const catSelect = document.getElementById('txCat');
        catSelect.innerHTML = '';
        db.cats[type].forEach(c => catSelect.add(new Option(c, c)));
        
        document.getElementById('txAmt').value = '';
        document.getElementById('txDate').valueAsDate = new Date();
        document.getElementById('txDesc').value = '';
        document.getElementById('previewImg').style.display = 'none';
        selectedImageData = null;
        txModal.show();
    }

    function saveTx() {
        const amt = parseFloat(document.getElementById('txAmt').value);
        if(!amt) return;
        
        const tx = {
            id: Date.now(),
            type: document.getElementById('txType').value,
            amt: amt,
            cat: document.getElementById('txCat').value,
            date: document.getElementById('txDate').value,
            desc: document.getElementById('txDesc').value,
            img: selectedImageData
        };
        
        db.txs.push(tx);
        saveDB();
        txModal.hide();
        refreshAll();
    }

    function refreshAll() {
        let inc = 0, exp = 0;
        db.txs.forEach(t => { if(t.type === 'gelir') inc += t.amt; else exp += t.amt; });
        
        document.getElementById('dispNet').innerText = (inc - exp).toFixed(2) + ' ₺';
        document.getElementById('dispInc').innerText = inc.toFixed(0);
        document.getElementById('dispExp').innerText = exp.toFixed(0);
        
        renderRecentList();
    }

    function renderRecentList() {
        const list = document.getElementById('recentList');
        list.innerHTML = '';
        const sorted = db.txs.slice().sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 15);
        
        sorted.forEach(t => {
            const isInc = t.type === 'gelir';
            list.innerHTML += `
                <div class="tx-list-item">
                    <div class="d-flex align-items-center gap-3">
                        ${t.img ? `<img src="${t.img}" class="tx-img-thumb" onclick="showFullImage('${t.img}')">` : `<div class="bg-light rounded-3 d-flex align-items-center justify-content-center" style="width:40px; height:40px;"><i class="bi bi-tag-fill text-muted"></i></div>`}
                        <div>
                            <div class="fw-bold">${t.cat}</div>
                            <small class="text-muted">${t.desc || t.date}</small>
                        </div>
                    </div>
                    <div class="fw-bold ${isInc ? 'text-success' : 'text-danger'}">${isInc ? '+' : '-'}${t.amt.toFixed(2)} ₺</div>
                </div>`;
        });
    }

    // --- ANALİZ SAYFASI ---
    function renderAnalysis() {
        const container = document.getElementById('yearlyStats');
        const year = new Date().getFullYear();
        const yearTxs = db.txs.filter(t => new Date(t.date).getFullYear() === year);
        
        let yInc = 0, yExp = 0;
        yearTxs.forEach(t => { if(t.type === 'gelir') yInc += t.amt; else yExp += t.amt; });
        
        container.innerHTML = `
            <div class="d-flex justify-content-between mb-2"><span>Yıllık Gelir:</span> <b class="text-success">${yInc.toLocaleString()} ₺</b></div>
            <div class="d-flex justify-content-between mb-3"><span>Yıllık Gider:</span> <b class="text-danger">${yExp.toLocaleString()} ₺</b></div>
            <div class="progress mb-2"><div class="progress-bar bg-primary" style="width: ${yInc > 0 ? (yExp/yInc)*100 : 0}%"></div></div>
            <small class="text-muted">Gelirinizin %${yInc > 0 ? ((yExp/yInc)*100).toFixed(0) : 0} kadarını harcadınız.</small>
        `;

        // Kategori Bazlı
        const catList = document.getElementById('catAnalysisList');
        catList.innerHTML = '';
        const cats = {};
        yearTxs.filter(t => t.type === 'gider').forEach(t => { cats[t.cat] = (cats[t.cat] || 0) + t.amt; });
        
        Object.keys(cats).sort((a,b) => cats[b] - cats[a]).forEach(c => {
            const pct = (cats[c] / yExp) * 100;
            catList.innerHTML += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between small fw-bold"><span>${c}</span><span>${cats[c].toFixed(0)} ₺</span></div>
                    <div class="progress mt-1"><div class="progress-bar" style="width: ${pct}%; background: var(--secondary)"></div></div>
                </div>`;
        });
    }

    // --- BORÇ / ALACAK ---
    function renderDebts() {
        const list = document.getElementById('debtList');
        list.innerHTML = '';
        db.debts.forEach(d => {
            const isTake = d.type === 'take';
            list.innerHTML += `
                <div class="debt-card">
                    <div>
                        <div class="fw-bold">${d.person}</div>
                        <small class="${isTake ? 'text-success' : 'text-danger'} fw-bold">${isTake ? 'ALACAK' : 'BORÇ'}</small>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="debt-val fs-5 ${isTake ? 'text-success' : 'text-danger'}">${d.amt} ₺</div>
                        <i class="bi bi-check-circle-fill text-muted fs-4" onclick="settleDebt(${d.id})"></i>
                    </div>
                </div>`;
        });
    }

    function saveDebt() {
        const person = document.getElementById('debtPerson').value;
        const amt = parseFloat(document.getElementById('debtAmt').value);
        if(person && amt) {
            db.debts.push({ id: Date.now(), person: person, amt: amt, type: document.getElementById('debtType').value });
            saveDB();
            debtModal.hide();
            renderDebts();
        }
    }

    function settleDebt(id) {
        if(confirm('Bu borç kapatıldı mı?')) {
            db.debts = db.debts.filter(d => d.id !== id);
            saveDB();
            renderDebts();
        }
    }

    // --- SİSTEM ---
    function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    function toggleTheme() { db.theme = db.theme === 'light' ? 'dark' : 'light'; applyTheme(db.theme); saveDB(); }
    function applyTheme(t) { document.documentElement.setAttribute('data-theme', t); document.getElementById('themeIcon').className = t === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill'; }
    function resetData() { if(confirm('Tüm veriler silinecek! Emin misiniz?')) { localStorage.removeItem(DB_KEY); location.reload(); } }

    function excelExport() {
        const data = db.txs.map(t => ({ Tarih: t.date, Tür: t.type, Kategori: t.cat, Tutar: t.amt, Açıklama: t.desc }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Harcamalar");
        XLSX.writeFile(wb, "Finans_V26_Rapor.xlsx");
    }

    function createPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const tr = (str) => str.replace(/ğ/g,'g').replace(/ş/g,'s').replace(/ı/g,'i').replace(/ö/g,'o').replace(/ü/g,'u').replace(/ç/g,'c');
        doc.text("Finans Pro V26 Raporu", 14, 15);
        const rows = db.txs.map(t => [t.date, tr(t.cat), t.type === 'gelir' ? '+' + t.amt : '-' + t.amt, tr(t.desc || '-')]);
        doc.autoTable({ head: [['Tarih', 'Kategori', 'Tutar', 'Aciklama']], body: rows, startY: 20 });
        doc.save('Rapor.pdf');
    }
</script>
</body>
</html>
