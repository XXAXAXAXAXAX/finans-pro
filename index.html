<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finans V30 (Final)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        /* TEMA DEƒûƒ∞≈ûKENLERƒ∞ */
        :root { --bg-color: #f8fafc; --card-bg: #ffffff; --text-color: #0f172a; --text-muted: #64748b; --border-color: #e2e8f0; --primary: #4f46e5; --secondary: #8b5cf6; --input-bg: #f8fafc; }
        [data-theme="dark"] { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #ffffff; --text-muted: #a0a0a0; --border-color: #333333; --input-bg: #2d2d2d; }

        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 90px; transition: 0.3s; }

        /* HEADER */
        .header-bg { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 20px 20px 30px 20px; border-radius: 0 0 35px 35px; color: white; box-shadow: 0 15px 40px -10px rgba(79, 70, 229, 0.4); }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .icon-btn { font-size: 1.5rem; color: white; cursor: pointer; opacity: 0.9; transition: 0.2s; background: none; border: none; }
        .total-balance { font-size: 3rem; font-weight: 800; letter-spacing: -1.5px; line-height: 1.1; }
        .stat-box { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 10px 20px; min-width: 100px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .budget-wrapper { background: rgba(255,255,255,0.1); border-radius: 10px; height: 8px; width: 100%; margin-top: 15px; overflow: hidden; }
        .budget-fill { height: 100%; background: #10b981; width: 0%; transition: 1s; }

        /* KARTLAR & Lƒ∞STE */
        .accounts-wrapper { margin-top: -30px; padding-left: 20px; overflow-x: auto; white-space: nowrap; scrollbar-width: none; padding-bottom: 10px; }
        .acc-card { position: relative; display: inline-block; background: var(--card-bg); width: 160px; padding: 15px; border-radius: 20px; margin-right: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border-color); vertical-align: top; }
        .acc-del-btn { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: #fee2e2; color: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }

        .tx-list-item { background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid var(--border-color); }
        .icon-box { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 15px; flex-shrink: 0; }
        
        /* TAKVƒ∞M */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; margin-bottom: 20px; }
        .cal-day-header { font-size: 0.8rem; font-weight: bold; color: var(--text-muted); padding-bottom: 5px; }
        .cal-day { height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: 1px solid transparent; position: relative; }
        .cal-day.has-tx { background-color: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; }
        .cal-day.active { background-color: var(--primary); color: white !important; }

        /* ABONELƒ∞K KARTI */
        .sub-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }

        /* KATEGORƒ∞ KARTI */
        .cat-card { background: var(--card-bg); border: 1px solid var(--border-color); padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }

        /* FOTOƒûRAF √ñNƒ∞ZLEME */
        .img-preview-box { width: 100%; height: 150px; border: 2px dashed var(--border-color); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-top: 10px; overflow: hidden; background: var(--input-bg); position: relative; cursor: pointer; }
        .img-preview-box img { width: 100%; height: 100%; object-fit: contain; display: none; }
        .img-icon-badge { width: 30px; height: 30px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--primary); }

        /* ORTAK */
        .modal-content { background-color: var(--card-bg); color: var(--text-color); border-radius: 24px; border: 1px solid var(--border-color); }
        .form-control, .form-select { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); height: 75px; display: flex; justify-content: space-around; align-items: center; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 900; border-top: 1px solid var(--border-color); }
        .nav-btn { font-size: 1.5rem; color: var(--text-muted); background: none; border: none; padding: 10px; }
        .nav-btn.active { color: var(--primary); }
        .fab-main { width: 65px; height: 65px; background: var(--text-color); color: var(--card-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; position: relative; top: -30px; border: 6px solid var(--bg-color); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        
        .page { display: none; padding-top: 20px; } .page.active { display: block; }
        .stat-bar-bg { height: 8px; background: var(--bg-color); border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .stat-bar-fill { height: 100%; background: var(--primary); border-radius: 4px; }
        .shop-item { background: var(--card-bg); border: 1px solid var(--border-color); padding: 15px; border-radius: 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .shop-item.checked { opacity: 0.5; text-decoration: line-through; background: var(--bg-color); }
        .check-circle { width: 24px; height: 24px; border: 2px solid var(--text-muted); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .shop-item.checked .check-circle { background: #10b981; border-color: #10b981; color: white; }
        #loader { position: fixed; inset: 0; background: var(--bg-color); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-primary mb-3"></div><h6 class="fw-bold">Y√ºkleniyor...</h6></div>

<div id="mainHeader" class="header-bg">
    <div class="header-controls">
        <div class="d-flex gap-3">
            <button class="icon-btn" onclick="settingsModal.show()"><i class="bi bi-gear-fill"></i></button>
            <button class="icon-btn" onclick="toggleTheme()"><i id="themeIcon" class="bi bi-moon-stars-fill"></i></button>
        </div>
        <div class="small fw-bold opacity-75">V30 FINAL</div>
    </div>

    <div class="text-center">
        <div class="small fw-bold opacity-75 mb-1">C√úZDAN BAKƒ∞YESƒ∞</div>
        <div class="total-balance" id="dispNet">0.00 ‚Ç∫</div>
        
        <div class="px-4">
            <div class="budget-wrapper"><div class="budget-fill" id="budgetBar"></div></div>
            <div class="d-flex justify-content-between mt-1 small opacity-75 fw-bold">
                <span>Harcama: <span id="spentVal">0</span></span>
                <span>Limit: <span id="limitVal">0</span></span>
            </div>
        </div>

        <div class="mt-4 d-flex justify-content-center gap-3">
            <div class="stat-box text-start">
                <div class="small opacity-75 fw-bold mb-1">GELƒ∞R</div>
                <div class="fw-bold fs-5 d-flex align-items-center gap-2"><i class="bi bi-arrow-down-circle-fill text-white"></i> <span id="dispInc">0</span></div>
            </div>
            <div class="stat-box text-start">
                <div class="small opacity-75 fw-bold mb-1">Gƒ∞DER</div>
                <div class="fw-bold fs-5 d-flex align-items-center gap-2"><i class="bi bi-arrow-up-circle-fill text-danger-emphasis"></i> <span id="dispExp">0</span></div>
            </div>
        </div>
    </div>
</div>

<div id="homePage" class="page active">
    <div class="accounts-wrapper" id="accWrapper"></div>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3"><h6 class="fw-bold text-muted small m-0">SON ƒ∞≈ûLEMLER</h6><small class="text-primary fw-bold" onclick="goPage('calendarPage')">Analiz</small></div>
        <div id="recentList" class="pb-5"></div>
    </div>
</div>

<div id="calendarPage" class="page container" style="display:none; padding-top:20px;">
    <h4 class="fw-bold mb-3">Takvim & Analiz</h4>
    <select id="calMonth" class="form-select fw-bold mb-4 shadow-sm" onchange="renderCalendar()"></select>
    <div class="calendar-grid" id="calGrid"></div>
    <div id="dayDetail" class="mb-4 d-none">
        <h6 class="fw-bold border-bottom pb-2">Se√ßili G√ºn ƒ∞≈ülemleri</h6>
        <div id="dayTxList"></div>
    </div>
    <hr class="border-secondary opacity-25 my-4">
    <h5 class="fw-bold mb-3">Kategori Analizi</h5>
    <div id="catStatsList" class="pb-5"></div>
</div>

<div id="listPage" class="page container" style="display:none; padding-top:20px;">
    <div class="d-flex justify-content-between mb-4">
        <h4 class="fw-bold m-0">Alƒ±≈üveri≈ü Listem</h4>
        <button class="btn btn-primary rounded-pill px-3 fw-bold" onclick="listModal.show()">+ Ekle</button>
    </div>
    <div id="shoppingList" class="pb-5"></div>
</div>

<div id="assetsPage" class="page container" style="display:none; padding-top:20px;">
    <div class="p-4 rounded-4 text-center mb-4 text-white shadow" style="background: linear-gradient(135deg, #10b981, #059669);">
        <div class="small opacity-75 fw-bold letter-spacing-2">TOPLAM SERVET</div>
        <div class="display-4 fw-bold mt-1" id="totalWealth">0.00 ‚Ç∫</div>
    </div>
    <div class="d-flex justify-content-between mb-3"><h5 class="fw-bold m-0">Varlƒ±klarƒ±m</h5><button class="btn btn-sm btn-outline-primary fw-bold rounded-pill" onclick="assetModal.show()">+ Ekle</button></div>
    <div id="assetList" class="mb-5"></div>
</div>

<div class="bottom-nav">
    <button class="nav-btn active" onclick="goPage('homePage', this)"><i class="bi bi-grid-fill"></i></button>
    <button class="nav-btn" onclick="goPage('calendarPage', this)"><i class="bi bi-calendar-week"></i></button>
    <div class="fab-main" onclick="menuModal.show()"><i class="bi bi-plus-lg"></i></div>
    <button class="nav-btn" onclick="goPage('listPage', this)"><i class="bi bi-cart-check"></i></button>
    <button class="nav-btn" onclick="goPage('assetsPage', this)"><i class="bi bi-piggy-bank"></i></button>
</div>

<div class="modal fade" id="menuModal"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content p-3"><h6 class="text-center text-muted fw-bold mb-3">EKLE</h6><div class="d-grid gap-2"><button class="btn btn-success p-3 fw-bold text-start" onclick="openTx('gelir')">Gelir</button><button class="btn btn-danger p-3 fw-bold text-start" onclick="openTx('gider')">Gider</button></div></div></div></div>

<div class="modal fade" id="settingsModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="fw-bold">Ayarlar & Ara√ßlar</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <h6 class="fw-bold text-primary mb-3">Y√∂netim</h6>
    <button class="btn btn-light w-100 fw-bold text-start mb-2 py-3 border" onclick="openSubsModal()">üîÑ Abonelik Y√∂neticisi</button>
    <button class="btn btn-light w-100 fw-bold text-start mb-2 py-3 border" onclick="openCatModal()">üè∑Ô∏è Kategorileri D√ºzenle</button>
    <hr>
    <h6 class="fw-bold text-primary mb-3">Veri & Rapor</h6>
    <button class="btn btn-outline-danger w-100 fw-bold mb-2" onclick="createPDF()">üìÑ PDF Raporu ƒ∞ndir</button>
    <button class="btn btn-outline-success w-100 fw-bold mb-2" onclick="excelExport()">üìä Excel ƒ∞ndir</button>
    <hr>
    <h6 class="fw-bold text-primary mb-3">Yedekleme & Sƒ±fƒ±rlama</h6>
    <button class="btn btn-dark w-100 fw-bold mb-2" onclick="backupData()">üì• Yedeƒüi ƒ∞ndir (Sakla)</button>
    <button class="btn btn-outline-dark w-100 fw-bold mb-2" onclick="triggerRestore()">üì§ Yedek Y√ºkle (Geri Getir)</button>
    <button class="btn btn-danger w-100 fw-bold mb-2" onclick="resetData()">‚ö†Ô∏è T√úM VERƒ∞LERƒ∞ Sƒ∞L</button>
    <input type="file" id="restoreInput" hidden onchange="restoreData(this)" accept=".json">
    <hr>
    <h6 class="fw-bold text-primary mb-2">B√ºt√ße Limiti</h6>
    <div class="input-group mb-4"><input type="number" id="budgetLimitInp" class="form-control fw-bold" placeholder="√ñrn: 20000"><button class="btn btn-primary" onclick="saveBudget()">Kaydet</button></div>
</div></div></div></div>

<div class="modal fade" id="subsModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="fw-bold">Abonelikler</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <div id="subsList" class="mb-3"></div>
    <hr>
    <h6 class="fw-bold small text-muted">Yeni Abonelik</h6>
    <input type="text" id="subName" class="form-control mb-2" placeholder="Adƒ± (√ñrn: Netflix)">
    <div class="row g-2"><div class="col-6"><input type="number" id="subAmt" class="form-control" placeholder="Tutar"></div><div class="col-6"><input type="number" id="subDay" class="form-control" placeholder="G√ºn (1-31)"></div></div>
    <button class="btn btn-primary w-100 fw-bold mt-3" onclick="saveSub()">EKLE</button>
</div></div></div></div>

<div class="modal fade" id="catModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="fw-bold">Kategoriler</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <ul class="nav nav-tabs mb-3"><li class="nav-item"><a class="nav-link active fw-bold" onclick="renderCatEdit('gider')" href="#">Gider</a></li><li class="nav-item"><a class="nav-link fw-bold" onclick="renderCatEdit('gelir')" href="#">Gelir</a></li></ul>
    <div id="catEditList" class="mb-3" style="max-height:200px; overflow-y:auto;"></div>
    <div class="input-group"><input type="text" id="newCatName" class="form-control" placeholder="Yeni Kategori"><button class="btn btn-success" onclick="addCat()">+</button></div>
</div></div></div></div>

<div class="modal fade" id="listModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="fw-bold">Alƒ±nacak Ekle</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="listItemName" class="form-control fw-bold" placeholder="√ñrn: S√ºt, Yumurta"></div><div class="modal-footer border-0"><button onclick="saveListItem()" class="btn btn-primary w-100 fw-bold">Lƒ∞STEYE EKLE</button></div></div></div></div>
<div class="modal fade" id="assetModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="fw-bold">Varlƒ±k Ekle</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="astName" class="form-control mb-3 fw-bold" placeholder="Varlƒ±k Adƒ± (√ñrn: Dolar)"><select id="astType" class="form-select mb-3"><option value="currency">D√∂viz</option><option value="gold">Altƒ±n</option><option value="other">Diƒüer</option></select><input type="number" id="astVal" class="form-control fw-bold fs-4 text-success" placeholder="TL Deƒüeri"></div><div class="modal-footer border-0"><button onclick="saveAsset()" class="btn btn-primary w-100 fw-bold">KAYDET</button></div></div></div></div>

<div class="modal fade" id="txModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0 pb-0"><h5 class="fw-bold" id="txTitle"></h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <input type="hidden" id="txType">
    <div class="row g-2 mb-3"><div class="col-8"><label class="small fw-bold text-muted">Tutar</label><input type="number" step="0.01" id="txAmt" class="form-control fs-4 fw-bold text-primary" placeholder="0"></div><div class="col-4"><label class="small fw-bold text-muted">KDV</label><select id="taxRate" class="form-select fs-6 fw-bold bg-light"><option value="20">%20</option><option value="10">%10</option><option value="0">%0</option></select></div></div>
    <div class="row g-2 mb-3"><div class="col-6"><label class="small fw-bold text-muted">Tarih</label><input type="date" id="txDate" class="form-control fw-bold"></div><div class="col-6"><label class="small fw-bold text-muted">Hesap</label><select id="txAcc" class="form-select fw-bold"></select></div></div>
    <div class="mb-3"><label class="small fw-bold text-muted">Kategori</label><select id="txCat" class="form-select fw-bold"></select></div>
    <input type="text" id="txDesc" class="form-control mb-3" placeholder="A√ßƒ±klama">
    <div class="img-preview-box" onclick="document.getElementById('txFile').click()">
        <span class="text-muted small fw-bold"><i class="bi bi-camera-fill fs-3 d-block text-center"></i>Fotoƒüraf/Fi≈ü Ekle</span>
        <img id="previewImg">
    </div>
    <input type="file" id="txFile" accept="image/*" hidden onchange="handleImage(this)">
</div><div class="modal-footer border-0 pt-0"><button onclick="saveTx()" class="btn btn-primary w-100 py-3 fw-bold rounded-4">KAYDET</button></div></div></div></div>

<div class="modal fade" id="accModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="fw-bold">Yeni Hesap</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="newAccName" class="form-control mb-3 fw-bold" placeholder="Adƒ±"><select id="newAccType" class="form-select mb-3"><option value="bank">Banka</option><option value="card">Kart</option><option value="cash">Nakit</option></select><input type="number" id="newAccBal" class="form-control fw-bold" placeholder="Bakiye"></div><div class="modal-footer border-0"><button onclick="addAccount()" class="btn btn-primary w-100 fw-bold">OLU≈ûTUR</button></div></div></div></div>

<div class="modal fade" id="viewImageModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content bg-transparent border-0 text-center">
    <img id="fullSizeImg" class="rounded-4 shadow-lg w-100">
    <div class="d-flex gap-2 justify-content-center mt-3">
        <button class="btn btn-light rounded-pill fw-bold px-4" data-bs-dismiss="modal">Kapat</button>
        <button class="btn btn-danger rounded-pill fw-bold px-4" onclick="deleteCurrentImage()"><i class="bi bi-trash"></i> Sil</button>
    </div>
</div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
    const DB_KEY = 'finans_v30_db'; // V30 olarak g√ºncelledim
    let db = JSON.parse(localStorage.getItem(DB_KEY)) || { 
        txs: [], accs: [{id:1,name:'Nakit',type:'cash',bal:0}], 
        assets:[], shopping:[], subs:[], 
        cats: { gelir:['Maa≈ü','Ek ƒ∞≈ü','Satƒ±≈ü'], gider:['Market','Yemek','Ula≈üƒ±m','Fatura','Kira','Eƒülence','Giyim','Diƒüer'] },
        budget: 0, theme: 'light' 
    };

    let menuModal, txModal, accModal, assetModal, listModal, settingsModal, subsModal, catModal, viewImageModal;
    let currentCatEditType = 'gider';
    let currentTxImage = null;
    let currentViewTxId = null; // G√∂r√ºnt√ºlenen i≈ülemin ID'sini tutmak i√ßin

    window.onload = function() {
        menuModal = new bootstrap.Modal(document.getElementById('menuModal'));
        txModal = new bootstrap.Modal(document.getElementById('txModal'));
        accModal = new bootstrap.Modal(document.getElementById('accModal'));
        assetModal = new bootstrap.Modal(document.getElementById('assetModal'));
        listModal = new bootstrap.Modal(document.getElementById('listModal'));
        settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
        subsModal = new bootstrap.Modal(document.getElementById('subsModal'));
        catModal = new bootstrap.Modal(document.getElementById('catModal'));
        viewImageModal = new bootstrap.Modal(document.getElementById('viewImageModal'));
        
        if(!db.cats || Array.isArray(db.cats)) db.cats = { gelir:['Maa≈ü','Ek ƒ∞≈ü'], gider:['Market','Yemek','Ula≈üƒ±m','Fatura','Kira','Eƒülence','Diƒüer'] };
        if(!db.subs) db.subs = [];

        applyTheme(db.theme);
        document.getElementById('budgetLimitInp').value = db.budget || '';
        checkNotifications();
        initFilters(); refreshAll();
    };

    // --- YEDEKLEME & SIFIRLAMA ---
    function backupData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "Finans_Yedek_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }
    function triggerRestore() { document.getElementById('restoreInput').click(); }
    function restoreData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data && data.txs) {
                    if(confirm('Dƒ∞KKAT! Mevcut veriler silinip yedek dosyasƒ±ndaki veriler y√ºklenecek. Emin misin?')) {
                        db = data; saveDB(); location.reload();
                    }
                } else { alert('Hatalƒ± yedek dosyasƒ±!'); }
            } catch(err) { alert('Dosya okunamadƒ±!'); }
        };
        reader.readAsText(file);
    }
    function resetData() {
        if(confirm('‚ö†Ô∏è Dƒ∞KKAT!\n\nT√ºm harcamalar, varlƒ±klar ve ayarlar KALICI OLARAK Sƒ∞Lƒ∞NECEK.\n\nOnaylƒ±yor musun?')) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    }

    // --- RESƒ∞M Sƒ∞LME (YENƒ∞) ---
    function deleteCurrentImage() {
        if(!currentViewTxId) return;
        if(confirm('Sadece bu fotoƒürafƒ± silmek istediƒüine emin misin?')) {
            const tx = db.txs.find(t => t.id === currentViewTxId);
            if(tx) {
                tx.img = null; // Resmi kaldƒ±r
                saveDB();
                viewImageModal.hide();
                refreshAll(); // Listeyi g√ºncelle
            }
        }
    }

    // --- Bƒ∞LDƒ∞Rƒ∞M & FOTOƒûRAF ---
    function checkNotifications() {
        if (!("Notification" in window)) return;
        const today = new Date().getDate();
        const dueSubs = db.subs.filter(s => parseInt(s.day) === today);
        if (dueSubs.length > 0) {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    dueSubs.forEach(s => new Notification("√ñdeme Hatƒ±rlatmasƒ± üîî", { body: `${s.name} aboneliƒüinin √∂deme g√ºn√º geldi!` }));
                }
            });
            setTimeout(() => { alert(`üîî √ñDEME G√úN√ú!\nBug√ºn ${dueSubs.length} adet √∂demen var.`); }, 1000);
        }
    }
    function handleImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentTxImage = e.target.result;
                const prev = document.getElementById('previewImg');
                prev.src = currentTxImage;
                prev.style.display = 'block';
                document.querySelector('.img-preview-box span').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    function showImage(id, src) { 
        currentViewTxId = id; // Hangi i≈ülem olduƒüunu kaydet
        document.getElementById('fullSizeImg').src = src; 
        viewImageModal.show(); 
    }

    // --- STANDART FONKSƒ∞YONLAR ---
    function goPage(pid, btn) {
        document.querySelectorAll('.page').forEach(p=>{p.style.display='none'; p.classList.remove('active')});
        document.getElementById(pid).style.display='block';
        if(btn){ document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        document.getElementById('mainHeader').style.display = (pid==='homePage')?'block':'none';
        if(pid==='homePage') refreshAll(); if(pid==='calendarPage') renderCalendar(); if(pid==='assetsPage') refreshAssets(); if(pid==='listPage') renderShoppingList();
    }
    function openTx(type){ 
        menuModal.hide(); document.getElementById('txType').value = type; document.getElementById('txTitle').innerText = type==='gelir'?'GELƒ∞R EKLE':'Gƒ∞DER EKLE'; 
        const c=document.getElementById('txCat'); c.innerHTML=''; db.cats[type].forEach(x=>c.add(new Option(x,x))); 
        const a=document.getElementById('txAcc'); a.innerHTML=''; db.accs.forEach(x=>a.add(new Option(x.name,x.id))); 
        document.getElementById('txAmt').value=''; document.getElementById('txDate').valueAsDate = new Date(); 
        currentTxImage = null; document.getElementById('previewImg').style.display = 'none'; document.querySelector('.img-preview-box span').style.display = 'block'; document.getElementById('txFile').value = '';
        txModal.show(); 
    }
    function saveTx(){ 
        const a=parseFloat(document.getElementById('txAmt').value); if(!a)return; const typ=document.getElementById('txType').value; 
        const tx={id:Date.now(), type:typ, amt:a, accId:parseInt(document.getElementById('txAcc').value), date:document.getElementById('txDate').value, cat:document.getElementById('txCat').value, desc:document.getElementById('txDesc').value, img: currentTxImage}; 
        const acc=db.accs.find(x=>x.id===tx.accId); if(acc) acc.bal+=(typ==='gelir'?a:-a); 
        db.txs.push(tx); saveDB(); txModal.hide(); refreshAll(); 
    }
    function refreshAll() {
        let i=0,e=0; db.txs.forEach(t=>{if(t.type==='gelir')i+=t.amt; else e+=t.amt;}); let walletTotal = 0; db.accs.forEach(a=>walletTotal+=a.bal);
        document.getElementById('dispNet').innerText=walletTotal.toFixed(2)+' ‚Ç∫'; document.getElementById('dispInc').innerText=i.toFixed(0); document.getElementById('dispExp').innerText=e.toFixed(0);
        document.getElementById('spentVal').innerText = e.toFixed(0); document.getElementById('limitVal').innerText = db.budget.toFixed(0);
        const bar = document.getElementById('budgetBar'); if(db.budget > 0) { const pct = Math.min((e / db.budget) * 100, 100); bar.style.width = pct + '%'; bar.style.background = pct < 80 ? '#10b981' : (pct < 100 ? '#f59e0b' : '#ef4444'); } else { bar.style.width = '0%'; }
        const aw=document.getElementById('accWrapper'); const addBtn=`<div class="add-acc-card" onclick="accModal.show()" style="display:inline-flex; align-items:center; justify-content:center; width:50px; height:100px; background:rgba(255,255,255,0.5); border-radius:20px; border:2px dashed #cbd5e1; cursor:pointer; vertical-align:top;"><i class="bi bi-plus-lg fs-3 text-muted"></i></div>`; aw.innerHTML=''; db.accs.forEach(a=>{ let ico='bi-wallet2'; if(a.type==='bank')ico='bi-bank'; if(a.type==='card')ico='bi-credit-card'; aw.innerHTML+=`<div class="acc-card"><div class="acc-del-btn" onclick="deleteAcc(${a.id})"><i class="bi bi-x"></i></div><div class="acc-icon"><i class="bi ${ico}"></i></div><div class="small fw-bold text-muted text-truncate">${a.name}</div><div class="fw-bold fs-5">${a.bal.toFixed(2)}‚Ç∫</div></div>`; }); aw.innerHTML+=addBtn;
        renderList('recentList', db.txs.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5));
    }
    function renderList(tid, list) { 
        const el=document.getElementById(tid); el.innerHTML=''; if(!list.length) el.innerHTML='<div class="text-center small text-muted my-3">Kayƒ±t yok</div>'; 
        list.forEach(t=>{ 
            const isInc=t.type==='gelir'; 
            el.innerHTML+=`<div class="tx-list-item"><div class="d-flex align-items-center"><div class="icon-box" style="background:${isInc?'#dcfce7':'#fee2e2'}; color:${isInc?'#166534':'#991b1b'}"><i class="bi ${isInc?'bi-arrow-down':'bi-bag'}"></i></div><div><div class="fw-bold">${t.cat}</div><small class="text-muted">${t.date}</small></div></div><div class="text-end d-flex align-items-center gap-2">${t.img ? `<div class="img-icon-badge" onclick="showImage(${t.id}, '${t.img}')"><i class="bi bi-image"></i></div>` : ''}<div class="fw-bold ${isInc?'text-success':'text-danger'}">${isInc?'+':'-'}${t.amt}‚Ç∫</div></div></div>`; 
        }); 
    }
    function createPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); const tr = (str) => str.replace(/ƒü/g,'g').replace(/≈ü/g,'s').replace(/ƒ±/g,'i').replace(/√∂/g,'o').replace(/√º/g,'u').replace(/√ß/g,'c'); doc.setFontSize(18); doc.text("FINANS PRO RAPORU", 14, 20); const tableData = db.txs.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => [t.date, tr(t.cat), tr(t.desc || '-'), t.type === 'gelir' ? `+${t.amt}` : `-${t.amt}`]); doc.autoTable({ head: [['Tarih', 'Kategori', 'Aciklama', 'Tutar']], body: tableData, startY: 30, theme: 'striped' }); doc.save('Rapor.pdf'); }
    function openSubsModal() { settingsModal.hide(); subsModal.show(); renderSubs(); }
    function renderSubs() { const l = document.getElementById('subsList'); l.innerHTML = ''; if(!db.subs.length) l.innerHTML = '<div class="text-center text-muted small">Abonelik yok.</div>'; db.subs.forEach(s => { l.innerHTML += `<div class="sub-card"><div><div class="fw-bold">${s.name}</div><div class="small text-muted">Her ayƒ±n ${s.day}. g√ºn√º ‚Ä¢ ${s.amt}‚Ç∫</div></div><button class="btn btn-sm btn-outline-primary" onclick="paySub(${s.id})">√ñde</button><i class="bi bi-trash3 text-danger ms-3" onclick="delSub(${s.id})" style="cursor:pointer"></i></div>`; }); }
    function saveSub() { const n = document.getElementById('subName').value; const a = parseFloat(document.getElementById('subAmt').value); const d = document.getElementById('subDay').value; if(n && a && d) { db.subs.push({id:Date.now(), name:n, amt:a, day:d}); saveDB(); renderSubs(); document.getElementById('subName').value=''; } }
    function delSub(id) { db.subs = db.subs.filter(s=>s.id!==id); saveDB(); renderSubs(); }
    function paySub(id) { const s = db.subs.find(x=>x.id===id); if(s) { subsModal.hide(); openTx('gider'); document.getElementById('txDesc').value = s.name + " Abonelik"; document.getElementById('txAmt').value = s.amt; document.getElementById('txCat').value = "Fatura"; } }
    function openCatModal() { settingsModal.hide(); catModal.show(); renderCatEdit('gider'); }
    function renderCatEdit(type) { currentCatEditType = type; const l = document.getElementById('catEditList'); l.innerHTML = ''; db.cats[type].forEach(c => { l.innerHTML += `<div class="cat-card"><span class="fw-bold">${c}</span><button class="btn btn-sm btn-light text-danger" onclick="delCat('${c}')"><i class="bi bi-trash"></i></button></div>`; }); document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active')); event.target.classList.add('active'); }
    function addCat() { const n = document.getElementById('newCatName').value; if(n && !db.cats[currentCatEditType].includes(n)) { db.cats[currentCatEditType].push(n); saveDB(); renderCatEdit(currentCatEditType); document.getElementById('newCatName').value = ''; } }
    function delCat(name) { if(confirm('Kategori silinsin mi?')) { db.cats[currentCatEditType] = db.cats[currentCatEditType].filter(c => c !== name); saveDB(); renderCatEdit(currentCatEditType); } }
    function renderCalendar() { const grid = document.getElementById('calGrid'); grid.innerHTML = ''; const m = parseInt(document.getElementById('calMonth').value); const y = new Date().getFullYear(); const daysInMonth = new Date(y, m + 1, 0).getDate(); const firstDay = new Date(y, m, 1).getDay(); ['Pz','Pt','Sa','√áa','Pe','Cu','Ct'].forEach(d => grid.innerHTML += `<div class="cal-day-header">${d}</div>`); for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`; for(let d=1; d<=daysInMonth; d++) { const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const hasTx = db.txs.some(t => t.date === dateStr); grid.innerHTML += `<div class="cal-day ${hasTx?'has-tx':''}" onclick="showDayDetails('${dateStr}', this)">${d}</div>`; } renderCatStats(m); }
    function showDayDetails(date, el) { document.querySelectorAll('.cal-day').forEach(d=>d.classList.remove('active')); if(el) el.classList.add('active'); const list = db.txs.filter(t => t.date === date); const ul = document.getElementById('dayTxList'); document.getElementById('dayDetail').classList.remove('d-none'); ul.innerHTML = ''; if(!list.length) ul.innerHTML = '<small class="text-muted">ƒ∞≈ülem yok.</small>'; list.forEach(t => { ul.innerHTML += `<div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded bg-light border"><div class="small fw-bold">${t.cat}</div><div class="fw-bold ${t.type==='gelir'?'text-success':'text-danger'}">${t.amt}‚Ç∫</div></div>`; }); }
    function renderCatStats(month) { const statsDiv = document.getElementById('catStatsList'); statsDiv.innerHTML = ''; const monthTxs = db.txs.filter(t => new Date(t.date).getMonth() === month && t.type === 'gider'); const totalExp = monthTxs.reduce((a,b) => a+b.amt, 0); if(totalExp === 0) { statsDiv.innerHTML = '<div class="text-center text-muted">Bu ay harcama yok.</div>'; return; } const cats = {}; monthTxs.forEach(t => { cats[t.cat] = (cats[t.cat] || 0) + t.amt; }); Object.keys(cats).sort((a,b)=>cats[b]-cats[a]).forEach(c => { const pct = (cats[c] / totalExp) * 100; statsDiv.innerHTML += `<div class="stat-row"><div class="d-flex justify-content-between small fw-bold"><span>${c}</span><span>${cats[c]}‚Ç∫ (%${pct.toFixed(0)})</span></div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div></div>`; }); }
    function renderShoppingList() { const l = document.getElementById('shoppingList'); l.innerHTML = ''; if(!db.shopping.length) l.innerHTML = '<div class="text-center text-muted mt-5">Listen bo≈ü</div>'; db.shopping.sort((a,b) => a.done - b.done).forEach(i => { l.innerHTML += `<div class="shop-item ${i.done?'checked':''}" onclick="toggleItem(${i.id})"><div class="check-circle"><i class="bi bi-check"></i></div><div class="flex-grow-1 fw-bold">${i.text}</div><i class="bi bi-x-circle text-danger fs-5" onclick="event.stopPropagation(); deleteItem(${i.id})"></i></div>`; }); }
    function saveListItem() { const t=document.getElementById('listItemName').value; if(t){db.shopping.push({id:Date.now(), text:t, done:false}); saveDB(); listModal.hide(); renderShoppingList(); document.getElementById('listItemName').value='';} }
    function toggleItem(id) { const i=db.shopping.find(x=>x.id===id); if(i){i.done=!i.done; saveDB(); renderShoppingList();} }
    function deleteItem(id) { if(confirm('Sil?')){db.shopping=db.shopping.filter(x=>x.id!==id); saveDB(); renderShoppingList();} }
    function saveAsset() { const nm = document.getElementById('astName').value; const val = parseFloat(document.getElementById('astVal').value); if(nm && val) { db.assets.push({id:Date.now(), name:nm, type:document.getElementById('astType').value, val:val}); saveDB(); assetModal.hide(); refreshAssets(); refreshAll(); } }
    function deleteAsset(id) { if(confirm('Sil?')) { db.assets = db.assets.filter(a=>a.id!==id); saveDB(); refreshAssets(); refreshAll(); } }
    function refreshAssets() { const al = document.getElementById('assetList'); al.innerHTML = ''; db.assets.forEach(a => { al.innerHTML += `<div class="asset-card"><div><div class="fw-bold d-flex align-items-center gap-2"><i class="bi bi-box-seam"></i> ${a.name}</div><small class="text-muted">Varlƒ±k</small></div><div class="text-end"><div class="fw-bold">${a.val.toLocaleString('tr-TR')} ‚Ç∫</div><i class="bi bi-trash3 text-danger opacity-50 ms-2" onclick="deleteAsset(${a.id})" style="cursor:pointer"></i></div></div>`; }); let totalCash = 0; db.accs.forEach(a=>totalCash+=a.bal); let totalAssetVal = db.assets.reduce((a,b)=>a+b.val, 0); document.getElementById('totalWealth').innerText = (totalCash + totalAssetVal).toLocaleString('tr-TR') + ' ‚Ç∫'; }
    function toggleTheme() { db.theme = db.theme === 'light' ? 'dark' : 'light'; applyTheme(db.theme); saveDB(); }
    function applyTheme(theme) { document.documentElement.setAttribute('data-theme', theme); document.getElementById('themeIcon').className = theme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill'; }
    function saveBudget() { db.budget = parseFloat(document.getElementById('budgetLimitInp').value)||0; saveDB(); refreshAll(); settingsModal.hide(); }
    function saveDB(){localStorage.setItem(DB_KEY,JSON.stringify(db))}
    function excelExport(){const ws=XLSX.utils.json_to_sheet(db.txs);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Data");XLSX.writeFile(wb,"FinansV30.xlsx")}
    function initFilters(){const m=["Ocak","≈ûubat","Mart","Nisan","Mayƒ±s","Haziran","Temmuz","Aƒüustos","Eyl√ºl","Ekim","Kasƒ±m","Aralƒ±k"]; const sc=document.getElementById('calMonth'); m.forEach((x,i)=>{const o=new Option(x,i); if(i===new Date().getMonth())o.selected=true; sc.add(o);});}
    function addAccount(){ const n=document.getElementById('newAccName').value; if(n){db.accs.push({id:Date.now(), name:n, type:document.getElementById('newAccType').value, bal:parseFloat(document.getElementById('newAccBal').value)||0}); saveDB(); accModal.hide(); refreshAll();} }
    function deleteAcc(id){ if(confirm("Hesap Silinsin mi?")){db.accs=db.accs.filter(a=>a.id!==id); saveDB(); refreshAll();} }

</script>
</body>
</html>
